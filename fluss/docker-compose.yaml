version: "3.9"

x-fluss-image: &fluss_image
  image: fluss-paimon-jdbc:0.8.0
  build:
    context: .
    dockerfile: Dockerfile
    args:
      FLUSS_TAG: 0.8.0-incubating
      PAIMON_VERSION: 0.8.0
      PGJDBC_VERSION: 42.7.8

services:
  zookeeper:
    image: zookeeper:3.9.2
    container_name: zookeeper
    restart: unless-stopped
    ports: ["2181:2181"]
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;2181
    volumes:
      - ./data/zookeeper/data:/data
      - ./data/zookeeper/datalog:/datalog

  fluss-coordinator:
    <<: *fluss_image
    container_name: fluss-coordinator
    restart: unless-stopped
    command: coordinatorServer
    depends_on: [zookeeper]
    ports: ["9123:9123"]
    environment:
      - |
        FLUSS_PROPERTIES=
        zookeeper.address: zookeeper:2181

        bind.listeners: INTERNAL://fluss-coordinator:0, CLIENT://fluss-coordinator:9123
        advertised.listeners: CLIENT://192.168.1.4:9123
        internal.listener.name: INTERNAL

        remote.data.dir: /tmp/fluss/remote-data

        # --- Lakehouse: Paimon (JDBC metastore + MinIO/S3 warehouse) ---
        datalake.format: paimon

        # These are passed to Paimon after stripping "datalake.paimon." :contentReference[oaicite:4]{index=4}
        datalake.paimon.metastore: jdbc
        datalake.paimon.uri: jdbc:postgresql://192.168.1.4:5433/paimon_catalog
        datalake.paimon.jdbc.user: root
        datalake.paimon.jdbc.password: root
        datalake.paimon.catalog-key: paimon_catalog

        datalake.paimon.warehouse: s3://warehouse/paimon
        datalake.paimon.s3.endpoint: http://192.168.1.4:3900
        datalake.paimon.s3.access-key: GK52dfd58afc72fa785017d472
        datalake.paimon.s3.secret-key: 9f0490ec49886f9f1c191e5d0c6022d3e1a3331bba21c110a8d53b740f00890d
        datalake.paimon.s3.path.style.access: true
    volumes:
      - ./data/fluss/remote:/tmp/fluss/remote-data

  fluss-tablet:
    <<: *fluss_image
    container_name: fluss-tablet
    restart: unless-stopped
    command: tabletServer
    depends_on: [fluss-coordinator]
    ports: ["9124:9123"]
    environment:
      - |
        FLUSS_PROPERTIES=
        zookeeper.address: zookeeper:2181

        tablet-server.id: 0

        bind.listeners: INTERNAL://fluss-tablet:0, CLIENT://fluss-tablet:9123
        advertised.listeners: CLIENT://192.168.1.4:9124
        internal.listener.name: INTERNAL

        data.dir: /tmp/fluss/data
        remote.data.dir: /tmp/fluss/remote-data
        kv.snapshot.interval: 0s

        datalake.format: paimon
        datalake.paimon.metastore: jdbc
        datalake.paimon.uri: jdbc:postgresql://192.168.1.4:5433/paimon_catalog
        datalake.paimon.jdbc.user: root
        datalake.paimon.jdbc.password: root
        datalake.paimon.catalog-key: paimon_catalog

        datalake.paimon.warehouse: s3://warehouse/paimon
        datalake.paimon.s3.endpoint: http://192.168.1.4:3900
        datalake.paimon.s3.access-key: GK52dfd58afc72fa785017d472
        datalake.paimon.s3.secret-key: 9f0490ec49886f9f1c191e5d0c6022d3e1a3331bba21c110a8d53b740f00890d
        datalake.paimon.s3.path.style.access: true
    volumes:
      - ./data/fluss/tablet:/tmp/fluss/data
      - ./data/fluss/remote:/tmp/fluss/remote-data
