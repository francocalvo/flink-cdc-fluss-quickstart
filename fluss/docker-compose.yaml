x-fluss-image: &fluss_image
  image: fluss-${DATALAKE_FORMAT}-jdbc:0.8.0
  build:
    context: .
    dockerfile: Dockerfile
    args:
      FLUSS_TAG: ${FLUSS_TAG:-0.8.0-incubating}
      PAIMON_VERSION: ${PAIMON_VERSION:-0.8.0}
      ICEBERG_VERSION: ${ICEBERG_VERSION:-1.9.1}
      PGJDBC_VERSION: ${PGJDBC_VERSION:-42.7.8}

services:
  zookeeper:
    image: zookeeper:3.9.2
    container_name: zookeeper
    restart: unless-stopped
    ports: ["2181:2181"]
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;2181
    volumes:
      - ./data/zookeeper/data:/data
      - ./data/zookeeper/datalog:/datalog

  fluss-coordinator:
    <<: *fluss_image
    container_name: fluss-coordinator
    restart: unless-stopped
    command: coordinatorServer
    depends_on: [zookeeper]
    ports: ["9123:9123"]
    environment:
      # AWS credentials for Iceberg (only used when DATALAKE_FORMAT=iceberg)
      AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${S3_SECRET_KEY}
      FLUSS_PROPERTIES: |
        zookeeper.address: zookeeper:2181

        bind.listeners: INTERNAL://fluss-coordinator:0, CLIENT://fluss-coordinator:9123
        advertised.listeners: CLIENT://${HOST_IP}:9123
        internal.listener.name: INTERNAL

        remote.data.dir: /tmp/fluss/remote-data

        # --- Data Lake Configuration ---
        datalake.format: ${DATALAKE_FORMAT}

        # Paimon Configuration (only populated when DATALAKE_FORMAT=paimon)
        datalake.paimon.metastore: ${PAIMON_METASTORE}
        datalake.paimon.uri: ${PAIMON_URI}
        datalake.paimon.jdbc.user: ${PAIMON_USER}
        datalake.paimon.jdbc.password: ${PAIMON_PASSWORD}
        datalake.paimon.catalog-key: ${PAIMON_CATALOG_KEY}
        datalake.paimon.warehouse: ${PAIMON_WAREHOUSE}
        datalake.paimon.s3.endpoint: ${S3_ENDPOINT}
        datalake.paimon.s3.access-key: ${S3_ACCESS_KEY}
        datalake.paimon.s3.secret-key: ${S3_SECRET_KEY}
        datalake.paimon.s3.path.style.access: ${S3_PATH_STYLE_ACCESS}

        # Iceberg Configuration (only populated when DATALAKE_FORMAT=iceberg)
        datalake.iceberg.type: ${ICEBERG_TYPE}
        datalake.iceberg.warehouse: ${ICEBERG_WAREHOUSE_PATH}
        datalake.iceberg.hadoop.fs.s3a.endpoint: ${ICEBERG_ENDPOINT}
        datalake.iceberg.hadoop.fs.s3a.access.key: ${ICEBERG_ACCESS_KEY}
        datalake.iceberg.hadoop.fs.s3a.secret.key: ${ICEBERG_SECRET_KEY}
        datalake.iceberg.hadoop.fs.s3a.path.style.access: ${ICEBERG_PATH_STYLE}
    volumes:
      - ./data/fluss/remote:/tmp/fluss/remote-data

  fluss-tablet:
    <<: *fluss_image
    container_name: fluss-tablet
    restart: unless-stopped
    command: tabletServer
    depends_on: [fluss-coordinator]
    ports: ["9124:9123"]
    environment:
      # AWS credentials for Iceberg (only used when DATALAKE_FORMAT=iceberg)
      AWS_ACCESS_KEY_ID: ${S3_ACCESS_KEY}
      AWS_SECRET_ACCESS_KEY: ${S3_SECRET_KEY}
      FLUSS_PROPERTIES: |
        zookeeper.address: zookeeper:2181

        tablet-server.id: 0

        bind.listeners: INTERNAL://fluss-tablet:0, CLIENT://fluss-tablet:9123
        advertised.listeners: CLIENT://${HOST_IP}:9124
        internal.listener.name: INTERNAL

        data.dir: /tmp/fluss/data
        remote.data.dir: /tmp/fluss/remote-data
        kv.snapshot.interval: 0s

        # --- Data Lake Configuration ---
        datalake.format: ${DATALAKE_FORMAT}

        # Paimon Configuration (only populated when DATALAKE_FORMAT=paimon)
        datalake.paimon.metastore: ${PAIMON_METASTORE}
        datalake.paimon.uri: ${PAIMON_URI}
        datalake.paimon.jdbc.user: ${PAIMON_USER}
        datalake.paimon.jdbc.password: ${PAIMON_PASSWORD}
        datalake.paimon.catalog-key: ${PAIMON_CATALOG_KEY}
        datalake.paimon.warehouse: ${PAIMON_WAREHOUSE}
        datalake.paimon.s3.endpoint: ${S3_ENDPOINT}
        datalake.paimon.s3.access-key: ${S3_ACCESS_KEY}
        datalake.paimon.s3.secret-key: ${S3_SECRET_KEY}
        datalake.paimon.s3.path.style.access: ${S3_PATH_STYLE_ACCESS}

        # Iceberg Configuration (only populated when DATALAKE_FORMAT=iceberg)
        datalake.iceberg.type: ${ICEBERG_TYPE}
        datalake.iceberg.warehouse: ${ICEBERG_WAREHOUSE_PATH}
        datalake.iceberg.hadoop.fs.s3a.endpoint: ${ICEBERG_ENDPOINT}
        datalake.iceberg.hadoop.fs.s3a.access.key: ${ICEBERG_ACCESS_KEY}
        datalake.iceberg.hadoop.fs.s3a.secret.key: ${ICEBERG_SECRET_KEY}
        datalake.iceberg.hadoop.fs.s3a.path.style.access: ${ICEBERG_PATH_STYLE}
    volumes:
      - ./data/fluss/tablet:/tmp/fluss/data
      - ./data/fluss/remote:/tmp/fluss/remote-data