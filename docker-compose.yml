services:
  postgres-catalog:
    image: postgres:14
    container_name: postgres-catalog
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: paimon_catalog
    ports:
      - "5433:5432"
    volumes:
      - ./data/postgres-catalog:/var/lib/postgresql/data
      - ./init-scripts/catalog:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root -d paimon_catalog"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - lakehouse

  postgres-source:
    image: postgres:14
    container_name: postgres-source
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: source_db
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres-source:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_replication_slots=4"
      - "-c"
      - "max_wal_senders=4"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root -d source_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - lakehouse

  localstack:
    image: localstack/localstack:3.4
    container_name: localstack
    environment:
      SERVICES: kinesis,sts,iam
      DEBUG: 0
      KINESIS_LATENCY: 0
      DEFAULT_REGION: us-east-1
    ports:
      - "4566:4566"
    volumes:
      - ./data/localstack:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - lakehouse

  garage:
    image: dxflrs/garage:v1.0.1
    container_name: garage
    ports:
      - "3900:3900"
      - "3901:3901"
      - "3902:3902"
      - "3903:3903"
    volumes:
      - ./data/garage/data:/var/lib/garage/data
      - ./data/garage/meta:/var/lib/garage/meta
      - ./config/garage.toml:/etc/garage.toml
    command: ["/garage", "server"]
    healthcheck:
      test: ["CMD", "/garage", "-c", "/etc/garage.toml", "status"]
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 20s
    networks:
      - lakehouse

  jobmanager:
    build:
      context: .
      dockerfile: Dockerfile.flink
    # image: flink-custom:latest
    container_name: flink-jobmanager
    command: jobmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
        state.backend.type: rocksdb
        state.checkpoints.dir: s3://warehouse/checkpoints
        state.savepoints.dir: s3://warehouse/savepoints
        s3.endpoint: http://garage:3900
        s3.path-style-access: true
        s3.access-key: ${GARAGE_ACCESS_KEY:-GKxxxxxxxxxxxxxxxx}
        s3.secret-key: ${GARAGE_SECRET_KEY:-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx}
    ports:
      - "8081:8081"
    volumes:
      - ./data/flink:/opt/flink/data
      - ./sql:/opt/flink/sql
    depends_on:
      postgres-catalog:
        condition: service_healthy
      postgres-source:
        condition: service_healthy
      garage:
        condition: service_healthy
    networks:
      - lakehouse

  taskmanager:
    build:
      context: .
      dockerfile: Dockerfile.flink
    container_name: flink-taskmanager
    command: taskmanager
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 4
        taskmanager.memory.process.size: 4g
        state.backend.type: rocksdb
        s3.endpoint: http://garage:3900
        s3.path-style-access: true
        s3.access-key: ${GARAGE_ACCESS_KEY:-GKxxxxxxxxxxxxxxxx}
        s3.secret-key: ${GARAGE_SECRET_KEY:-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx}
    volumes:
      - ./data/flink:/opt/flink/data
      - ./sql:/opt/flink/sql
    depends_on:
      - jobmanager
    deploy:
      replicas: 2
    networks:
      - lakehouse

  sql-client:
    build:
      context: .
      dockerfile: Dockerfile.flink
    container_name: flink-sql-client
    command: >
      bash -c "
        sleep 30 &&
        /opt/flink/bin/sql-client.sh
      "
    environment:
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: jobmanager
        rest.address: jobmanager
        s3.endpoint: http://garage:3900
        s3.path-style-access: true
        s3.access-key: ${GARAGE_ACCESS_KEY:-GKxxxxxxxxxxxxxxxx}
        s3.secret-key: ${GARAGE_SECRET_KEY:-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx}
    volumes:
      - ./sql:/opt/flink/sql
    depends_on:
      - jobmanager
      - taskmanager
    stdin_open: true
    tty: true
    networks:
      - lakehouse

  fluss-coordinator:
    image: apache/fluss:0.8.0-incubating
    container_name: fluss-coordinator
    command: coordinatorServer
    depends_on:
      - zookeeper
    environment:
      - |
        FLUSS_PROPERTIES=
        zookeeper.address: zookeeper:2181
        bind.listeners: FLUSS://fluss-coordinator:9123
        remote.data.dir: /tmp/fluss/remote-data
    ports:
      - "9123:9123"
    volumes:
      - ./data/fluss/remote:/tmp/fluss/remote-data
    networks:
      - lakehouse

  fluss-tablet:
    image: apache/fluss:0.8.0-incubating
    container_name: fluss-tablet
    command: tabletServer
    depends_on:
      - fluss-coordinator
    environment:
      - |
        FLUSS_PROPERTIES=
        zookeeper.address: zookeeper:2181
        bind.listeners: FLUSS://fluss-tablet:9123
        data.dir: /tmp/fluss/data
        remote.data.dir: /tmp/fluss/remote-data
        kv.snapshot.interval: 0s
    volumes:
      - ./data/fluss/tablet:/tmp/fluss/data
      - ./data/fluss/remote:/tmp/fluss/remote-data
    networks:
      - lakehouse

  zookeeper:
    image: zookeeper:3.9.2
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;2181
    volumes:
      - ./data/zookeeper/data:/data
      - ./data/zookeeper/datalog:/datalog
    networks:
      - lakehouse

networks:
  lakehouse:
    driver: bridge
